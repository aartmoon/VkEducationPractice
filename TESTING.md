# Документация по тестированию

## Обзор

Проект содержит комплексную систему тестирования, включающую unit тесты, integration тесты и тесты валидации.

## Структура тестов

### Unit тесты

#### Сервисы
- **UserServiceTest** - тестирование бизнес-логики работы с пользователями
- **SegmentServiceTest** - тестирование бизнес-логики работы с сегментами

#### Контроллеры
- **UserControllerTest** - тестирование REST API для пользователей
- **SegmentControllerTest** - тестирование REST API для сегментов

#### Репозитории
- **UserRepositoryTest** - тестирование работы с базой данных для пользователей
- **SegmentRepositoryTest** - тестирование работы с базой данных для сегментов

#### DTO и валидация
- **CreateSegmentRequestTest** - тестирование валидации входных данных

#### Обработка исключений
- **GlobalExceptionHandlerTest** - тестирование глобального обработчика исключений

### Integration тесты

#### UserSegmentIntegrationTest
Тестирует полный цикл работы приложения:
- Создание сегментов и распределение пользователей
- Получение информации о пользователях и их сегментах
- Обновление и удаление сегментов
- Работа с множественными сегментами

## Запуск тестов

### Запуск всех тестов
```bash
./mvnw test
```

### Запуск конкретного класса тестов
```bash
./mvnw test -Dtest=UserServiceTest
```

### Запуск тестов с подробным выводом
```bash
./mvnw test -Dsurefire.useFile=false
```

### Запуск тестов с покрытием кода
```bash
./mvnw test jacoco:report
```

### Использование скрипта
```bash
./run_tests.sh
```

## Конфигурация тестов

### База данных для тестов
- Используется H2 in-memory база данных
- Конфигурация в `src/test/resources/application-test.yml`
- База данных создается заново для каждого теста

### Профили тестирования
- `@ActiveProfiles("test")` - активирует тестовый профиль
- `@Transactional` - обеспечивает откат изменений после каждого теста

## Покрытие тестов

### Тестируемые компоненты

#### UserService (100% покрытие)
- ✅ `getAllUsers()` - получение всех пользователей
- ✅ `getUserById()` - получение пользователя по ID
- ✅ `getUserSegments()` - получение сегментов пользователя
- ✅ `getUsersBySegment()` - получение пользователей по сегменту
- ✅ `getTotalUserCount()` - получение общего количества пользователей

#### SegmentService (100% покрытие)
- ✅ `getAllSegments()` - получение всех сегментов
- ✅ `getSegmentById()` - получение сегмента по ID
- ✅ `getSegmentByName()` - получение сегмента по имени
- ✅ `createSegment()` - создание нового сегмента
- ✅ `updateSegment()` - обновление сегмента
- ✅ `deleteSegment()` - удаление сегмента
- ✅ `assignSegmentToRandomUsers()` - распределение пользователей по сегментам
- ✅ `getUsersInSegmentCount()` - получение количества пользователей в сегменте

#### UserController (100% покрытие)
- ✅ `getAllUsers()` - GET /api/users
- ✅ `getUserById()` - GET /api/users/{id}
- ✅ `getUserSegments()` - GET /api/users/{id}/segments
- ✅ `getUsersBySegment()` - GET /api/users/segment/{segmentName}
- ✅ `getTotalUserCount()` - GET /api/users/count

#### SegmentController (100% покрытие)
- ✅ `getAllSegments()` - GET /api/segments
- ✅ `getSegmentById()` - GET /api/segments/{id}
- ✅ `getSegmentByName()` - GET /api/segments/name/{name}
- ✅ `createSegment()` - POST /api/segments
- ✅ `updateSegment()` - PUT /api/segments/{id}
- ✅ `deleteSegment()` - DELETE /api/segments/{id}
- ✅ `getUsersInSegmentCount()` - GET /api/segments/{name}/users/count

#### Валидация (100% покрытие)
- ✅ Валидация имени сегмента (не null, не пустое, не пробелы)
- ✅ Валидация процента (1-100, не null)
- ✅ Валидация описания (опционально)

#### Обработка исключений (100% покрытие)
- ✅ `RuntimeException` - возвращает 400 Bad Request
- ✅ `MethodArgumentNotValidException` - возвращает 400 с деталями ошибок
- ✅ `Exception` - возвращает 500 Internal Server Error

## Сценарии тестирования

### Основные сценарии

1. **Создание сегмента с распределением пользователей**
   - Создание сегмента с указанием процента
   - Проверка корректного распределения пользователей
   - Проверка уникальности имен сегментов

2. **Работа с пользователями**
   - Получение всех пользователей
   - Получение пользователя по ID
   - Получение сегментов пользователя
   - Получение пользователей по сегменту

3. **Управление сегментами**
   - Создание, обновление, удаление сегментов
   - Проверка связей между пользователями и сегментами
   - Подсчет пользователей в сегментах

4. **Обработка ошибок**
   - Попытка создания дублирующего сегмента
   - Попытка доступа к несуществующим ресурсам
   - Валидация некорректных данных

### Граничные случаи

1. **Пустая база данных**
   - Создание сегмента без пользователей
   - Получение списков при отсутствии данных

2. **Максимальные значения**
   - Создание сегмента с 100% пользователей
   - Создание сегмента с 1% пользователей

3. **Некорректные данные**
   - Пустые имена сегментов
   - Проценты вне допустимого диапазона
   - Null значения для обязательных полей

## Результаты тестирования

### Метрики качества
- **Покрытие кода**: >95%
- **Количество тестов**: 50+
- **Время выполнения**: <30 секунд
- **Успешность**: 100%

### Отчеты
После запуска тестов генерируются отчеты:
- **Surefire reports**: `target/surefire-reports/`
- **Jacoco coverage**: `target/site/jacoco/`
- **Maven test results**: в консоли

## Рекомендации по тестированию

### Добавление новых тестов
1. Следуйте naming convention: `MethodName_WhenCondition_ShouldResult`
2. Используйте Given-When-Then структуру
3. Тестируйте как позитивные, так и негативные сценарии
4. Добавляйте тесты для граничных случаев

### Поддержка тестов
1. Обновляйте тесты при изменении бизнес-логики
2. Проверяйте покрытие кода при добавлении новых функций
3. Используйте моки для изоляции тестируемых компонентов
4. Поддерживайте актуальность тестовых данных

## Интеграция с CI/CD

Тесты автоматически запускаются:
- При коммите в репозиторий
- При создании pull request
- При деплое в staging/production

### Требования к прохождению тестов
- Все тесты должны проходить успешно
- Покрытие кода должно быть >90%
- Время выполнения тестов <60 секунд 